rules:
  - name: "metadata_ignored"
    query: "$..metadata"
    condition: "exists"
    error: "Metadata field is ignored at runtime! It is only used for HA editor. Remove it or use 'variables:'"

  #D1
  - name: "wrong_state_case_trigger"
    query: "$.triggers[?(@.trigger_type=='state')].to_"
    condition: "contains"
    substring: "On|Off|Open|Close|True|False"
    error: "State values should be lowercase ('on' not 'On'). Check HA Developer Tools for valid states."

  - name: "wrong_state_case_codnition"
    query: "$.conditions[?(@.condition_type=='state')].state"
    condition: "contains"
    substring: "On|Off|Open|Close|True|False"
    error: "State values should be lowercase ('on' not 'On'). Check HA Developer Tools for valid states."

  - name: "wrong_state_case_action"
    query: "$.actions[?(@.action_type=='service')].data.state"
    condition: "contains"
    substring: "On|Off|Open|Close|True|False"
    error: "State values should be lowercase ('on' not 'On'). Check HA Developer Tools for valid states."
  #D2
  - name: "wrong_trigger_type"
    query: "$.triggers[?(@.trigger_type=='device')].params.for"
    condition: "contains"
    substring: "{{"
    error: "Templates ('{{ ... }}' in 'for') not supported in 'device' trigger. Switch to a 'state' or 'numeric_state' trigger type."
  #D3
  - name: "wrong_data_retrieval_no_states"
    query: "$..value_template | $..wait_template | $.actions[?(@.action_type=='service')].data.*"
    condition: "matches_regex"
    regex: "(?<!states\\(['\"])\\b\\w+\\.\\w+\\b"
    error: "Direct entity references ('sensor.my_sensor') in templates are invalid. Use 'states(\"entity_id\")' to access states."
  #D5
  - name: "wrong_sun_predicates_condition"
    query: "$..conditions[?(@.condition_type=='sun' & @.before=='sunrise' & @.after=='sunset')]"
    condition: exists
    error: "Invalid combination of 'before: sunrise' and 'after: sunset' in a single sun condition"

  - name: "sun_pred_action_cond"
    query: "$.actions[?(@.action_type=='if')].if_[?(@.condition_type=='sun' & @.before=='sunrise' & @.after=='sunset')]"
    condition: exists
    error: "Invalid combination of 'before: sunrise' and 'after: sunset' in a single sun condition in action"

  - name: "repeat_action_while_until"
    query: "$.actions[?(@.action_type=='repeat')]"
    condition: exists
    error: "Invalid combination of 'before: sunrise' and 'after: sunset' in a single sun condition in action"

  - name: "wrong_sun_predicates_trigger"
    query: "$.triggers[?(@.params.trigger=='sun' & @.params.offset != null)].params"
    condition: offset
    error: "Invalid 'offset' value in a single sun trigger"

  - name: "wrong_time_predicates_trigger"
    query: "$.triggers[?(@.params.trigger=='time' & @.params.offset != null)].params"
    condition: offset
    error: "Invalid 'offset' value in a single time trigger"

  - name: "wrong_numeric_state_trigger_range"
    query: "$.triggers[?(@.params.trigger=='numeric_state' & @.params.above != null & @.params.below != null)].params"
    condition: "exists"
    error: "Invalid range of numeric_state trigger 'above' cannot be greater than 'below'"

  - name: "wrong_numeric_state_condition_range"
    query: "$.conditions[?(@.condition_type=='numeric_state' & @.above != null & @.below != null)]"
    condition: "exists"
    error: "Invalid range of numeric_state condition 'above' cannot be greater than 'below'"

  - name: "zone_trigg_conf_events"
    query: "$.triggers[?(@.trigger_type=='zone')]"
    condition: "exists"
    error: "Conflicting event in zone trigger (enter & leave)"
  #D6
  - name: "wrong_value_template_placement"
    query: "$..conditions[?(@.condition_type!='template' & @.condition_type!='numeric_state' & @.extra_params.*)] | $..actions[*].if_[?(@.condition_type!='template' & @.condition_type!='numeric_state' & @.extra_params.*)]"
    condition: "exists"
    error: "not supported atribute used in either 'if' or clasic condition"

  - name: "wrong_value_while_placement"
    query: $..actions[*].while_[?(@.condition_type!='template' & @.condition_type!='numeric_state' & @.extra_params.*)]
    condition: "exists"
    error: "not supported atribute used in 'while' condition"

  - name: "wrong_value_until_placement"
    query: $..actions[*].until[?(@.condition_type!='template' & @.condition_type!='numeric_state' & @.extra_params.*)]
    condition: "exists"
    error: "not supported atribute used in either 'until' condition"
  #D7 recomendation
  - name: "warning_state_check_missing"
    query: "$..actions[?(@.action_type=='service')]"
    condition: "exists"
    error: "Recommendation: Check actual state of 'service' to prevent redundant executions"
  #D8 
  - name: "wait_for_trigger_params"
    query: "$.actions[?(@.action_type=='wait_for_trigger')].wait_for_trigger[?(@.params.to)].params"
    condition: exists
    error: "wait_for_trigger may not occur, cannot have 'to' without 'from', 'wait_template' use is suggested"

  - name: "wait_for_trigger"
    query: "$.actions[?(@.action_type=='wait_for_trigger')].wait_for_trigger"
    condition: exists
    error: "wait_for_trigger same as main trigger, might cause deadlock"
  #D11
  - name: "wrong_atribute__in_service_action"
    query: "$..actions[?(@.action_type=='service' & @.extra_params.*)]"
    condition: "exists"
    error: "not supported attribute used in 'service' action"
  #D13
  - name: "state_used_in_action"
    query: "$..*[?(@.action_type=='service' & @.data.state)]"
    condition: "exists"
    error: "cannot use 'state' in actions, using 'service' is recommended"
  #D15
  - name: "wrong_wait_template_usage_D1"
    query: "$..actions[?(@.action_type=='wait_template')].wait_template"
    condition: "contains"
    substring: "On|Off|Open|Close|True|False"
    error: "State values should be lowercase ('on' not 'On'). Check HA Developer Tools for valid states."

  - name: "wrong_wait_template_usage_D15"
    query: "$..actions[?(@.action_type=='wait_template' & @.timeout=='None')].wait_template"
    condition: "contains"
    substring: "on|off|open|close|true|false|<|>|<=|>=|=="
    error: "Recommendation: 'wait_template' only re-evaluates when one of the referenced entities changes state. If the condition becomes true BEFORE entering 'wait_template' and no entity changes afterward, it may wait forever.
    

            'wait_template' without a 'timeout' can wait indefinitely if the condition is never met again. 
            Adding 'timeout: HH:MM:SS' and 'continue_on_timeout: true/false' recommended."
  #D16
  - name: "missing_action"
    query: "$.triggers[?(@.trigger_type=='empty')]"
    condition: "exists"
    error: "no 'triggers' defined"
    
  - name: "missing_trigger"
    query: "$.actions[?(@.action_type=='empty')]"
    condition: "exists"
    error: "no 'actions' defined"